<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="James Mba Azam">

<title>Basics of R for Infectious Disease Modelling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="R_basics_for_IDM_files/libs/clipboard/clipboard.min.js"></script>
<script src="R_basics_for_IDM_files/libs/quarto-html/quarto.js"></script>
<script src="R_basics_for_IDM_files/libs/quarto-html/popper.min.js"></script>
<script src="R_basics_for_IDM_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="R_basics_for_IDM_files/libs/quarto-html/anchor.min.js"></script>
<link href="R_basics_for_IDM_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="R_basics_for_IDM_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="R_basics_for_IDM_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="R_basics_for_IDM_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="R_basics_for_IDM_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Basics of R for Infectious Disease Modelling</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>James Mba Azam </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="objectives" class="level1">
<h1>Objectives</h1>
<p>The aim of this session is to introduce you to the basics of coding within R.</p>
<p>To do this, we will introduce you to the basic syntax, via the use of some simple commands such as how to read in data and plot. We will end with the introduction to methods for ODE solving in R.</p>
<p>In this session, you will</p>
<ol type="1">
<li>familiarise yourself with the basic syntax of R</li>
<li>learn how to create basic plots in R</li>
<li>simulate an SIR model in R</li>
<li>adapt an SIR model to include births and deaths, producing cycles</li>
</ol>
<p>The best thing to do is to read each section and type (or copy and paste) the R commands (in grey boxes) into your own R session to check that you understand the code. All the data need is in the <code>/data/</code> directory.</p>
<p>You can either work in a single R window, or use the user friendly interface RStudio, which allows you to have your saved R code, separate to your executed commands. It also holds the plot, environment and history window. Using RStudio you can keep your model code (in a file called ‘file.R’, where you can replace ‘file’ with any name you like) separate to your executed code in the Console window. In this ‘file.R’ you can store the useful and checked code for future use. For example, you could start a new R file and store in it all the commands below.</p>
</section>
<section id="basic-syntax" class="level1">
<h1>Basic syntax</h1>
<section id="commenting-code" class="level2">
<h2 class="anchored" data-anchor-id="commenting-code">Commenting code</h2>
<p>Within R code, anything behind a <code>#</code> is “commented” out and won’t be executed. It is good coding practice to comment your code as you go through.</p>
<pre><code># This is commented code. </code></pre>
<p>You can use this in your R file to comment what the code is doing in your own words.</p>
</section>
<section id="working-directory" class="level2">
<h2 class="anchored" data-anchor-id="working-directory">Working directory</h2>
<p>The first step when creating a new R file is to specify a working directory. This is the folder on your computer in which you are working. It is likely to be the folder in which the R code is saved (but it doesn’t have to be). Each computer will have a different specified address for the working directory. Upon opening R, you can find out “where you are” using</p>
<p>You need to tell the R session where you want it to work. To do this you use the command to “set the working directory” or <code>setwd()</code>.</p>
<p>In general, setting the working directory is problematic as it is tied to only your computer and anyone else using your code may not be able to access the paths you specified.</p>
<p>For a more reproducible approach, two approaches are strongly recommended: you can use an <a href="https://support.posit.co/hc/en-us/articles/200526207-Using-RStudio-Projects">Rproj</a> file, or harness the power of the simple <a href="https://here.r-lib.org/">here</a> R package. According to the README of the <code>here</code> package, “[it] creates paths relative to the top-level directory. The package displays the top-level of the current project on load or any time you call here()”.</p>
<p>Let’s see how <code>here()</code> works</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/lshja16/Documents/Git_repositories/_Work/GWAC/mppr"</code></pre>
</div>
</div>
<p>What happened? Can you compare your result with the next person to you?</p>
<p>Another example, let’s specify the path to the data</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/lshja16/Documents/Git_repositories/_Work/GWAC/mppr/data"</code></pre>
</div>
</div>
<p>And the path to the <code>data/data.csv</code> file.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/lshja16/Documents/Git_repositories/_Work/GWAC/mppr/data/data.csv"</code></pre>
</div>
</div>
<p>The result you see here will adapt to the computer on which you’re working.</p>
<p>Moving forward, we will construct paths using the <code>here()</code> function, so make sure you understand it. Check especially the section on reading in data below.</p>
</section>
<section id="mathematical-elements-in-r" class="level2">
<h2 class="anchored" data-anchor-id="mathematical-elements-in-r">Mathematical elements in R</h2>
<p>The following symbols represent</p>
<ul>
<li>multiplication: <code>*</code></li>
<li>addition: <code>+</code></li>
<li>subtraction: <code>-</code></li>
<li>assignment of a name to an object: <code>-&gt;</code></li>
</ul>
<p>To check if something is equal use <code>==</code>, or not equal using <code>!=</code>.</p>
<p>Below are examples of the main mathematical structures that we will use in R. Copy the below text into your R session and change the numbers so that you can follow what each command is doing.</p>
<p>The basic element is the vector:</p>
<p>You can also construct and manipulate matrices:</p>
<p>Can you generate a matrix of size 10 x 5, filled with 2s except for the first column that has the sequence 1 to 10?</p>
<p>Simple commands such as ‘sum’ are already encoded in R.</p>
<p>Other types of allocations include:</p>
</section>
<section id="help-files" class="level2">
<h2 class="anchored" data-anchor-id="help-files">Help files</h2>
<p>To find help in R you can use several different commands. For example, if you wanted to know more about the “sum” command you would type:</p>
<p>The first two are equivalent, whilst the last will do a full text search of all R’s help files. This is most useful when you aren’t sure of what the exact function is called in R. In RStudio, there is also the option to search the help tab in the bottom right window. Google is also very useful for finding commands.</p>
<p>Can you use <code>??</code> to find out how you would generate binomial random numbers in R?</p>
</section>
<section id="packages-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="packages-and-libraries">Packages and libraries</h2>
<p>As R is open source, it is being developed and added to all the time. It is likely that you may need commands that are not in the standard R programme that you have installed.</p>
<p>To get access to these other functions, you need to install ‘packages’. These contain ‘libraries’ of functions, already coded into R, that can perform new or different functions.</p>
<p>There are two ways to do this: 1) In RStudio, go to the “Packages” tab and search for the required package and load it. 2) Type</p>
<p>replacing “packagename” with the name of the package you would like to install. For example, can you install the package <code>deSolve</code>? We will use this to solve ordinary differential equations later on in this practical.</p>
<p>Once installed you then have to load the package at the start of the R file. This is done using</p>
</section>
<section id="reading-in-data" class="level2">
<h2 class="anchored" data-anchor-id="reading-in-data">Reading in data</h2>
<p>In order to read in data, the first thing to do is to check that you are pointing R at the right folder by setting the appropriate working directory. To do this make sure you <code>setwd(where_the_data_is)</code>, to point R to wherever you have decided to store your files.</p>
<p>There are many ways to read in data. Here, as we have ‘.csv’ files we could either use <code>read.table()</code></p>
<p>or <code>read.csv()</code></p>
<p>Here both <code>mydata</code> and <code>flu_hh</code> are the same data. Can you check this in R?</p>
<p>The data is read in in the form of a <code>data.frame</code>. This is a type of data format in R that allows the inclusion of both numbers and strings (letters). There is more information on reading in data <a href="http://www.statmethods.net/input/importingdata.html">here</a>.</p>
<p>There are several useful tools to look at the data we have read in. Copy the below code into your R session and check that you understand all the commands.</p>
<p>How would you go about finding the maximum time in this data? At what time is the number of cases at its maximum? See if you can write code to do this yourself. To do this you may need to use the function <code>which</code> that searches for the location of matching values. The solution to this task is below.</p>
<p>To add another column to a <code>data.frame</code> you simply refer to the name of this new column and assign it to have certain values. For example, to add in a column of percentages:</p>
</section>
<section id="basic-plotting" class="level2">
<h2 class="anchored" data-anchor-id="basic-plotting">Basic plotting</h2>
<p>R has inbuilt useful functions for creating plots. Again, copy and paste the below and check the differences in the output. The command <code>plot</code> creates a new plot window which can then be added to using <code>lines</code> or <code>points</code>. By default <code>plot</code> will create a plot with points, to alter this use the <code>type="l"</code> command as shown below.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-19-4.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-19-5.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can also alter the size of the axis to focus on certain areas. For example, use the <code>max_prop</code> from above to focus on the increase in the outbreak only.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In order to save plots, again you need to check you are in the correct working directory. Then open a file and insert the plot like this:</p>
<p>You can also plot multiple plots together. For example, using the <code>par</code> command, you can divide the window and then place the plots within it.</p>
<p>In order to output data, there is a write equivalent to read (again make sure you are in the appropriate working directory):</p>
<p>A quick note here on “not a numbers”. In R these are <code>NA</code> or <code>NaN</code>. This is usually an error or the result of a silly division.</p>
</section>
<section id="conditionals" class="level2">
<h2 class="anchored" data-anchor-id="conditionals">Conditionals</h2>
<p>Conditionals are built in functions that allow you to compare and contrast elements in R. For example, the <code>which</code> function gives you the index of values that match some condition:</p>
<p><code>if</code> statements allow you to compare elements</p>
<p>or check that data had been read in ok:</p>
<p>or check that what you are calling a proportion sums to 1:</p>
<p><code>if</code> statements can be combined (as in Excel) with else statements. These can be simple:</p>
<p>or more complex:</p>
<p>Some useful commands in R to help with checking code such as the if/else statement above are:</p>
<p>INDENT: “Command + I” on OS X, “Ctrl + I” on Windows. Highlight all code and hit enter. Helps find mistakes and lays out code nicely</p>
<p>COMMENT: “Command + C” on OS X, “Ctrl + Shift + C”. As above but makes all code selected commented. Useful if you want to comment out a load of code and run without it temporarily.</p>
</section>
<section id="for-loops" class="level2">
<h2 class="anchored" data-anchor-id="for-loops">For loops</h2>
<p>For those of you who have coded before, you will know the importance of <code>for</code> loops. For those who are new to coding, these structures are very useful in allowing you to repeat a set of commands multiple times to different elements.</p>
<p>For example, you can use <code>for</code> loops to generate the two times table</p>
<p>Or to fill a vector with the first 50 Fibonacci numbers:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the above example, we built an empty vector to fill within the <code>for</code> loop. However, we may not know the end size of the resulting vector and so in this case can instead concatenate:</p>
</section>
<section id="writing-your-own-functions" class="level2">
<h2 class="anchored" data-anchor-id="writing-your-own-functions">Writing your own functions</h2>
<p>Functions are useful ways of packaging up pieces of code. If you are going to do a set of commands multiple times then it can be simpler and cleaner to place them in a function that has been thoroughly checked and that you have not altered subsequently.</p>
<p>To build a function you use the syntax</p>
<p>Within the ‘code’ section you need to include the main coding information, which uses the inputs and also ‘returns’ an output.</p>
<p>For example, to build your own function for calculating the mean do:</p>
<p>To run the function you need the function name and the correct inputs:</p>
<p>You can store all the functions that you have in one big .R file and load them into your current R file using the command <code>source</code>.</p>
<p>Can you understand what the following function does?</p>
<p>Does this give you the output you expected? You will need to use some of the commands for looking at data that were introduced above. The file <code>ward_data.csv</code> can be found in the <code>/data/</code> directory.</p>
</section>
</section>
<section id="writing-and-solving-ordinary-differential-equations" class="level1">
<h1>Writing and solving ordinary differential equations</h1>
<p>In order to write and solve ODEs, you need to learng the basic <code>ode</code> syntax in R and load the package that we installed earlier (<code>deSolve</code>). Remember that to do this you need to type:</p>
<p>The package <code>deSolve</code> includes a function <code>ode</code> that solves ODE equations. This function needs certain inputs. Have a look at</p>
<p>and see if you can understand what the required inputs are.</p>
<p>For this part of the practical, we will build and solve our own SIR model. We will compare it to data and try to determine the correct parameters.</p>
<p>Firstly we need to read in the data, which is stored in <code>data/data_sir.csv</code>.</p>
<p>Can you make a simple plot to check what this SIR outbreak looks like?</p>
<p>As described in the help pages for <code>ode</code>, this function itself requires several inputs including another function.</p>
<p>The first input it requires are the initial conditions. We have to specify the initial conditions for all of the states. Here we have three states, S, I and R:</p>
<p>Can you alter this initial vector for a population of 100,000 to have initially one infected and the rest susceptible?</p>
<p>The second required input are the times over which the output for the ODE is wanted. Note this is not the same as the timesteps over which the ODE will be solved. These are specified by the method. Here lets assume lets say we want output every year for 40 years.</p>
<p>The third required input is the function itself, which governs the dynamics between the states. Here as we have an SIR model we can translate the differential equations into three simple relationships:</p>
<p>Finally, the <code>ode</code> function requires the input parameters, which here are only beta and gamma:</p>
<p>In order to run the function we input all of the above and save the output in a vector called <code>out</code>:</p>
<p>What does the output data look like? Does it make sense? Can you build a simple plot to look at the change in the number Infected over time?</p>
<p>To look at all of the model output we can plot everything on the same graph:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Does this match the data you read before in using <code>read.csv</code> well? Note, that the data given is the proportions infected over time. So in order to compare you either need to convert the data to numbers or the numbers to data. Try and do this, and plot the data and model output on the same graph. A solution is given below if you get stuck.</p>
<p>What we are doing here is assessing our model’s “fit” to the data. This is a key stage in the development of any model - does it refect reality? The simplest way to do this is by plotting model output and data together and comparing them by eye. Over the next few days, we will introduce several more formal and quantitative methods for assessing a model “fit”.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Assume you know that the value for <code>beta</code> is 2/100000. Can you write a function that considers a range of different parameters for <code>gamma</code>, runs the model with these various values and then plots the outcomes with the data? From this what is the best estimate you can get for <code>gamma</code>?</p>
<p>Note that this was output generated with a set value for gamma and so you can find a solution - however in the real world epidemic there is unlikely to be such a perfect fit!</p>
<p>The solution to the code is below, but try not to look at this before having a go yourself. This will use all the skills you’ve learnt in R above and will prepare you for the rest of the course.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="R_basics_for_IDM_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>You can store your data for the SIR solution at different gamma values using (as above):</p>
</section>
<section id="going-further" class="level1">
<h1>Going further</h1>
<section id="the-sir-model-with-births-and-deaths" class="level2">
<h2 class="anchored" data-anchor-id="the-sir-model-with-births-and-deaths">The SIR model with births and deaths</h2>
<p>In the lecture yesterday, you saw the infection cycles that occur when you use an SIR model with births and deaths. If you have gotten this far, try to build and solve using ode, your own version of this SIR model with births and deaths.</p>
<p>Remember that the set of ordinary differential equations for this is: <span class="math display">\[\frac{dS}{dt} = - \beta \frac{I}{N} S + \nu N - \mu S \\
\frac{dI}{dt} =  \beta \frac{I}{N} S -\gamma I - \mu I \\
\frac{dR}{dt} = \gamma I - \mu R \]</span>.</p>
<p>Initial parameters from the lecture were: <span class="math display">\[ \beta = 500, \gamma = 50, \nu = 0.02 \]</span>.</p>
<p>Remember that the population size should stay constant, at say 1,000.</p>
</section>
<section id="extending-the-sir-model" class="level2">
<h2 class="anchored" data-anchor-id="extending-the-sir-model">Extending the SIR model</h2>
<p>If you have time, you can now try to build more complex versions of the SIR model to match the infectious disease you are interested in. For example, you could try and include multiple strains of influenza or extend the model to include some of the complexity of TB. The first stage would be to sketch the model structure on paper. Remember that simplicity is the key and that you will need data to inform any parameter values. Secondly, translate the model structure into differential equations. Thirdly, translate the differential equations into a new function to use in the ode solver function.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>